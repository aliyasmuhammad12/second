(function($){var LOCAL_STORAGE_KEY='DOTDIGITAL_AB_TRACKING';var MIL_SECONDS=60000;function getExpirationDate(cartDelay,creationTimestamp){return parseInt(creationTimestamp+(cartDelay*MIL_SECONDS),10);}
function addDataToLocalStorageAction(ajaxResponse){var success=false;var $dmDataElement=null;if(typeof ajaxResponse===undefined||!ajaxResponse){$dmDataElement=$('.dotdigital_push_data').last();}else{$dmDataElement=$('#dotdigital_push_data');}
if($dmDataElement.length&&$dmDataElement.val()!==''){var dmDataObj=JSON.parse($dmDataElement.val());var dmDataFromLocalStorage=localStorage.getItem(LOCAL_STORAGE_KEY);var isOrderConfirmation=$dmDataElement.data('order-details');if(dmDataFromLocalStorage&&isOrderConfirmation===true){dmDataFromLocalStorage=JSON.parse(dmDataFromLocalStorage);var cartUUID=dmDataFromLocalStorage.cartID;dmDataObj.cartID=cartUUID;}
localStorage.setItem(LOCAL_STORAGE_KEY,JSON.stringify(dmDataObj));success=true;}else{localStorage.removeItem(LOCAL_STORAGE_KEY);success=true;}
return success;}
function pushDataFromLocalStorage(){var success=false;var dmDataFromLocalStorage=localStorage.getItem(LOCAL_STORAGE_KEY);if(dmDataFromLocalStorage&&Object.keys(dmDataFromLocalStorage).length>0){var $dmDataElement=$('.dotdigital_push_data').last();if($dmDataElement.length!==0&&$dmDataElement.val()!==''){var dmDataObj=JSON.parse($dmDataElement.val());if($dmDataElement.length&&Object.keys(dmDataObj).length>0){dmDataFromLocalStorage=JSON.parse(dmDataFromLocalStorage);var isExpired=new Date().getTime()>getExpirationDate(dmDataFromLocalStorage.cartDelay,dmDataFromLocalStorage.creationTimestamp);if(isExpired){var isOrderConfirmation=$dmDataElement.data('order-details');if(isOrderConfirmation===true){var cartUUID=dmDataFromLocalStorage.cartID;dmDataObj.cartID=cartUUID;}
localStorage.removeItem(LOCAL_STORAGE_KEY);localStorage.setItem(LOCAL_STORAGE_KEY,JSON.stringify(dmDataObj));}}}
var customerEmail=$dmDataElement.attr('data-customer-email');if(customerEmail){window.dmPt('identify',customerEmail);success=true;}
var cartJson=localStorage.getItem(LOCAL_STORAGE_KEY);if(cartJson&&cartJson!=='null'){window.dmPt('cartInsight',JSON.parse(cartJson));success=true;}}
return success;}
function abandonBasketTracking(ajaxResponse){var addDataToLocalStorage=new Promise(function(resolve,reject){try{resolve(addDataToLocalStorageAction(ajaxResponse));}catch(e){reject(new Error(e.message));}});addDataToLocalStorage.then(function(response){if(response){pushDataFromLocalStorage();}}).catch(function(error){console.log(error);});}
function updateLocalStorage(){var siteID=$('#dotdigital-currentSiteId');var siteName='';if(siteID&&siteID.attr('data-siteid')){siteName=siteID.attr('data-siteid');}
setTimeout(function(){var url='/on/demandware.store/Sites-'+siteName+'-Site/default/Dotdigital-Basket';$.ajax({url:url,type:'get',dataType:'json',success:function(data){var abandonedCartStatus=$('#dotdigital-abandonedcart-tracking');if(abandonedCartStatus&&abandonedCartStatus.attr('data-enable-tracking')==='true'){$('#dotdigital_push_data').val(data.dotdigitalBuildData);abandonBasketTracking(data.dotdigitalCartData);}}});},1000);}
$('body').on('product:afterAddToCart',function(event,data){var abandonedCartStatus=$('#dotdigital-abandonedcart-tracking');if(abandonedCartStatus&&abandonedCartStatus.attr('data-enable-tracking')==='true'){$('#dotdigital_push_data').val(data.cart.dotdigitalBuildData);abandonBasketTracking(data.cart.dotdigitalCartData);}});$('body').on('dotdigital:updateStorage',function(event,data){if($('#dotdigital_push_data').data('customer-email')==null||$('#dotdigital_push_data').data('customer-email')==''){var email=$('.card.customer-section #email-guest').val();email=(email&&email.length)>0?email:($('.card.customer-summary .customer-summary-email')[0]?$('.card.customer-summary .customer-summary-email')[0].innerText:'');$('#dotdigital_push_data').attr('data-customer-email',email);$('#dotdigital_json_data').attr('data-customer-email',email);}
if($('#dotdigital_json_data').attr('data-customer-email')&&$('#dotdigital_json_data').attr('data-customer-email')!='null'){updateLocalStorage();}});$('body').on('change','.quantity-form > select',function(){updateLocalStorage();});$('body').on('click','.cart-delete-confirmation-btn',function(){updateLocalStorage();});$('body').on('change','.shippingMethods',function(){updateLocalStorage();});$('.promo-code-form').submit(function(){updateLocalStorage();});$('body').on('click','.delete-coupon-confirmation-btn',function(){updateLocalStorage();});if($('#order-details').length>0){addDataToLocalStorageAction();var productData=$('#order-details').val();if(productData!==''){productData=JSON.parse(productData);var products=productData.products;for(var i=0;i<products.length;i++){_dmTrack('product',products[i].name);}
_dmTrack('CheckOutAmount',productData.checkoutAmount);}}else{addDataToLocalStorageAction();}})(window.jQuery);